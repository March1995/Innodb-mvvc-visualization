# InnoDB MVCC 可视化系统 - 更新说明

## 版本 2.0 更新内容

### 🎉 新增功能

#### 1. InnoDB 隐藏字段可视化

现在数据行展示中会突出显示 InnoDB 的三个隐藏字段：

- **DB_ROW_ID (行ID)**: InnoDB 自动生成的行标识符
- **DB_TRX_ID (事务ID)**: 最后修改该行的事务ID
- **DB_ROLL_PTR (回滚指针)**: 指向 Undo Log 的指针，用于版本链回溯

**展示效果：**
- 隐藏字段使用蓝色边框的独立区域展示
- 每个字段都有清晰的标签和值
- NULL 值使用灰色斜体显示
- 用户数据与隐藏字段分开展示，更加清晰

**教学价值：**
- 直观理解 InnoDB 如何在每行数据中存储 MVCC 相关信息
- 清楚看到事务ID和回滚指针如何随着数据修改而变化
- 理解版本链是如何通过 roll_pointer 连接的


#### 2. 分屏对比视图

新增了强大的分屏对比功能，可以同时查看两个事务的视角：

**功能特点：**
- 点击页面顶部的"切换到分屏对比模式"按钮进入分屏模式
- 左右两个面板分别展示不同事务的视角
- 每个面板包含：
  - ReadView 详细信息
  - 该事务能看到的所有数据行
  - 不可见的数据行会标记为"不可见"并显示原因

**使用场景：**

**场景1：对比不同隔离级别**
```
1. 开启事务1 (READ_COMMITTED)
2. 开启事务2 (REPEATABLE_READ)
3. 插入一些数据并提交
4. 切换到分屏模式，对比两个事务看到的数据
```

**场景2：演示 MVCC 可见性规则**
```
1. 事务1插入数据但不提交
2. 开启事务2
3. 分屏对比：
   - 事务1能看到自己插入的数据
   - 事务2看不到事务1未提交的数据
```

**场景3：演示不可重复读**
```
1. 开启事务1 (READ_COMMITTED)
2. 开启事务2 (READ_COMMITTED)
3. 事务1插入数据并提交
4. 分屏对比：
   - 事务2能看到事务1提交的数据（不可重复读）
```

**场景4：演示可重复读**
```
1. 开启事务1 (REPEATABLE_READ)
2. 开启事务2 (REPEATABLE_READ)
3. 事务1插入数据并提交
4. 分屏对比：
   - 事务2看不到事务1提交的数据（可重复读）
```


### 🎨 界面优化

#### 数据行展示优化
- 隐藏字段使用独立的蓝色边框区域
- 用户数据使用白色背景区域
- 删除标记更加醒目（⚠️ 已标记删除）
- 整体布局更加清晰，层次分明

#### 分屏视图样式
- 左右面板使用浅灰色背景
- 中间使用渐变色分隔线
- 不可见数据行使用红色边框和半透明效果
- 每个数据行都显示完整的隐藏字段信息


### 📚 使用指南

#### 如何使用分屏对比视图

1. **进入分屏模式**
   - 点击页面顶部的"切换到分屏对比模式"按钮

2. **选择要对比的事务**
   - 在"事务1"和"事务2"下拉框中选择要对比的事务
   - 系统会自动选择前两个活跃事务

3. **查看对比结果**
   - 左侧面板：事务1的视角
   - 右侧面板：事务2的视角
   - 每个面板显示：
     - ReadView 信息（creator_trx_id, m_ids, min_trx_id, max_trx_id）
     - 可见的数据行（绿色边框）
     - 不可见的数据行（红色边框，标记为"不可见"）

4. **刷新对比**
   - 点击"刷新对比"按钮更新视图
   - 系统会自动每3秒刷新一次

5. **返回普通模式**
   - 点击"切换到普通模式"按钮


#### 如何理解隐藏字段

**DB_ROW_ID (行ID)**
- InnoDB 自动生成的唯一标识符
- 如果表没有主键，InnoDB 会使用这个字段作为主键
- 单调递增

**DB_TRX_ID (事务ID)**
- 最后修改该行的事务ID
- 用于 MVCC 可见性判断
- 每次更新都会改变

**DB_ROLL_PTR (回滚指针)**
- 指向 Undo Log 的指针
- 用于版本链回溯
- 连接所有历史版本


### 🔧 技术实现

#### 前端改进
- 新增视图模式切换功能
- 实现分屏布局和样式
- 优化数据行渲染逻辑
- 添加隐藏字段专用样式

#### 后端改进
- 保持原有 API 不变
- 利用现有的 ReadView 可见性判断
- 通过 `/api/data/read` 接口检查数据可见性


### 📖 教学建议

#### 推荐演示流程

**第一步：理解隐藏字段**
1. 开启一个事务并插入数据
2. 观察数据行的隐藏字段
3. 更新数据，观察 DB_TRX_ID 和 DB_ROLL_PTR 的变化

**第二步：理解 ReadView**
1. 开启多个事务
2. 在右侧面板查看每个事务的 ReadView
3. 理解 m_ids、min_trx_id、max_trx_id 的含义

**第三步：使用分屏对比**
1. 切换到分屏模式
2. 选择两个事务进行对比
3. 观察同一数据行在不同事务中的可见性
4. 理解 MVCC 的可见性规则

**第四步：演示隔离级别差异**
1. 创建 READ_COMMITTED 和 REPEATABLE_READ 事务
2. 使用分屏对比观察它们的行为差异
3. 理解不可重复读和可重复读的区别


### 🚀 快速开始

```bash
# 启动应用
./start.sh

# 或者手动启动
source venv/bin/activate
python app.py

# 访问 Web 界面
浏览器打开: http://localhost:5002
```


### 💡 使用技巧

1. **快速对比两个事务**
   - 先开启两个事务
   - 切换到分屏模式
   - 系统会自动选择这两个事务进行对比

2. **观察版本链变化**
   - 在普通模式下点击数据行查看版本链
   - 在分屏模式下查看不同事务看到的版本

3. **理解可见性规则**
   - 在分屏模式下，不可见的数据会明确标记
   - 鼠标悬停可以看到详细的可见性判断原因

4. **演示并发场景**
   - 开启3-4个事务
   - 在分屏模式下两两对比
   - 观察不同事务之间的隔离效果


### 📝 注意事项

1. **性能考虑**
   - 分屏模式会对每个数据行进行可见性检查
   - 数据行较多时可能会有轻微延迟
   - 建议数据行数量控制在 50 行以内

2. **浏览器兼容性**
   - 推荐使用 Chrome、Firefox、Safari 等现代浏览器
   - 需要支持 CSS Grid 和 Flexbox

3. **自动刷新**
   - 系统每3秒自动刷新一次
   - 在分屏模式下，选择的事务会保持不变


### 🎓 学习资源

- [MySQL InnoDB 官方文档](https://dev.mysql.com/doc/refman/8.0/en/innodb-storage-engine.html)
- [InnoDB MVCC 原理详解](https://dev.mysql.com/doc/refman/8.0/en/innodb-multi-versioning.html)
- [InnoDB 行格式](https://dev.mysql.com/doc/refman/8.0/en/innodb-row-format.html)


### 🐛 已知问题

1. 分屏模式下，如果选择的事务被提交，需要重新选择
2. 数据行过多时，分屏视图可能需要滚动查看
3. 移动端暂不支持分屏模式（会自动切换为单列布局）


### 🔮 未来计划

- [ ] 添加事务时间线视图
- [ ] 支持更多事务的多屏对比（3-4个事务）
- [ ] 添加可见性规则的详细解释提示
- [ ] 支持导出对比结果
- [ ] 添加更多预设演示场景


---

**版本**: 2.0
**更新日期**: 2026-01-14
**作者**: Claude & User
