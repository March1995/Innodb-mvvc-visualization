<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InnoDB MVCC 可视化系统</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>InnoDB MVCC 可视化系统</h1>
            <p class="subtitle">多版本并发控制 (Multi-Version Concurrency Control) 演示</p>
        </header>

        <!-- 核心原理说明 -->
        <div class="core-principles">
            <div class="principle-card">
                <h3>🔍 ReadView 可见性规则</h3>
                <div class="principle-content">
                    <p><strong>规则1:</strong> trx_id == creator_trx_id → <span class="highlight-success">可见</span>（自己修改的数据）</p>
                    <p><strong>规则2:</strong> trx_id &lt; min_trx_id → <span class="highlight-success">可见</span>（ReadView创建前已提交）</p>
                    <p><strong>规则3:</strong> trx_id &gt; max_trx_id → <span class="highlight-error">不可见</span>（ReadView创建后才开始）</p>
                    <p><strong>规则4:</strong> min_trx_id ≤ trx_id ≤ max_trx_id:</p>
                    <ul>
                        <li>trx_id in m_ids → <span class="highlight-error">不可见</span>（创建ReadView时还未提交）</li>
                        <li>trx_id not in m_ids → <span class="highlight-success">可见</span>（创建ReadView时已提交）</li>
                    </ul>
                </div>
            </div>

            <div class="principle-card">
                <h3>🔗 版本链回溯原理</h3>
                <div class="principle-content">
                    <p><strong>步骤1:</strong> 检查当前版本是否可见（通过 DB_TRX_ID 判断）</p>
                    <p><strong>步骤2:</strong> 如果不可见，通过 DB_ROLL_PTR 指向的 Undo Log 回溯</p>
                    <p><strong>步骤3:</strong> 沿着 Undo Log 链向前查找，直到找到第一个可见的版本</p>
                    <p><strong>关键点:</strong></p>
                    <ul>
                        <li>当前行数据是<span class="highlight-info">最新版本</span></li>
                        <li>Undo Log 记录的是<span class="highlight-info">历史版本</span></li>
                        <li>每个版本都有对应的事务ID，用于可见性判断</li>
                        <li>版本链通过 roll_pointer 连接，形成完整的历史记录</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- 视图模式切换 -->
        <div class="view-mode-toggle">
            <button class="btn btn-secondary" onclick="toggleViewMode()">
                <span id="viewModeText">切换到分屏对比模式</span>
            </button>
        </div>

        <div class="main-content" id="mainContent">
            <!-- 左侧：事务控制面板 -->
            <div class="left-panel">
                <div class="panel">
                    <h2>事务控制</h2>
                    <div class="control-group">
                        <label>隔离级别:</label>
                        <select id="isolationLevel">
                            <option value="READ_COMMITTED">READ COMMITTED</option>
                            <option value="REPEATABLE_READ">REPEATABLE READ</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="beginTransaction()">开启新事务</button>
                    <button class="btn btn-danger" onclick="resetSystem()">重置系统</button>
                </div>

                <div class="panel">
                    <h2>数据操作</h2>
                    <div class="control-group">
                        <label>事务ID:</label>
                        <input type="number" id="opTrxId" placeholder="输入事务ID">
                    </div>
                    <div class="control-group">
                        <label>行ID (更新/删除/读取):</label>
                        <input type="number" id="opRowId" placeholder="输入行ID">
                    </div>
                    <div class="control-group">
                        <label>数据 (JSON格式):</label>
                        <textarea id="opData" placeholder='{"name": "张三", "age": 25}'></textarea>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-success" onclick="insertData()">插入</button>
                        <button class="btn btn-warning" onclick="updateData()">更新</button>
                        <button class="btn btn-danger" onclick="deleteData()">删除</button>
                        <button class="btn btn-info" onclick="readData()">读取</button>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="commitSpecificTransaction()">提交事务</button>
                        <button class="btn btn-secondary" onclick="rollbackSpecificTransaction()">回滚事务</button>
                    </div>
                </div>

                <div class="panel">
                    <h2>活跃事务列表</h2>
                    <div id="activeTransactions" class="transaction-list"></div>
                </div>
            </div>

            <!-- 中间：数据行和版本链展示 -->
            <div class="middle-panel">
                <div class="panel">
                    <h2>数据行列表</h2>
                    <div id="dataRows" class="data-rows"></div>
                </div>

                <div class="panel">
                    <h2>版本链可视化</h2>
                    <div id="versionChain" class="version-chain"></div>
                </div>
            </div>

            <!-- 右侧：ReadView和UndoLog展示 -->
            <div class="right-panel">
                <div class="panel">
                    <h2>ReadView 视图</h2>
                    <div id="readViews" class="read-views"></div>
                </div>

                <div class="panel">
                    <h2>Undo Log 日志</h2>
                    <div id="undoLogs" class="undo-logs"></div>
                </div>

                <div class="panel">
                    <h2>已提交事务</h2>
                    <div id="committedTransactions" class="transaction-list"></div>
                </div>
            </div>
        </div>

        <!-- 分屏对比视图 -->
        <div class="split-view-container" id="splitViewContainer" style="display: none;">
            <div class="split-view-header">
                <h2>事务视角对比</h2>
                <div class="split-view-controls">
                    <div class="control-group">
                        <label>事务1:</label>
                        <select id="splitTrx1"></select>
                    </div>
                    <div class="control-group">
                        <label>事务2:</label>
                        <select id="splitTrx2"></select>
                    </div>
                    <button class="btn btn-info" onclick="refreshSplitView()">刷新对比</button>
                </div>
            </div>

            <div class="split-view-content">
                <div class="split-view-panel">
                    <h3 id="splitTrx1Title">事务 #1 的视角</h3>
                    <div class="split-view-section">
                        <h4>ReadView 信息</h4>
                        <div id="splitTrx1ReadView" class="split-readview"></div>
                    </div>
                    <div class="split-view-section">
                        <h4>可见的数据行</h4>
                        <div id="splitTrx1Data" class="split-data"></div>
                    </div>
                </div>

                <div class="split-view-divider"></div>

                <div class="split-view-panel">
                    <h3 id="splitTrx2Title">事务 #2 的视角</h3>
                    <div class="split-view-section">
                        <h4>ReadView 信息</h4>
                        <div id="splitTrx2ReadView" class="split-readview"></div>
                    </div>
                    <div class="split-view-section">
                        <h4>可见的数据行</h4>
                        <div id="splitTrx2Data" class="split-data"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 消息提示 -->
        <div id="message" class="message"></div>
    </div>

    <script src="/static/js/app.js"></script>
</body>
</html>
