# InnoDB MVCC 可视化系统 - 快速启动指南

## 🚀 快速开始

### 1. 安装依赖

```bash
pip install flask
```

### 2. 运行测试（可选）

```bash
python3 test_mvcc.py
```

预期输出：
```
🎉 所有测试通过！
总计: 7 个测试
通过: 7 个
失败: 0 个
```

### 3. 启动服务器

```bash
python3 app.py
```

### 4. 访问界面

打开浏览器访问: http://127.0.0.1:5001

---

## 📖 使用示例

### 示例1：基本的 MVCC 可见性

```
1. 点击"开启事务" → 事务1创建
2. 在"数据操作"区域：
   - 事务ID: 1
   - 数据: {"name": "Alice", "age": 25}
   - 点击"插入数据"
3. 点击事务1的"提交"按钮
4. 点击"开启事务" → 事务2创建
5. 在"数据操作"区域：
   - 事务ID: 2
   - 行ID: 1
   - 数据: {"name": "Alice", "age": 26}
   - 点击"更新数据"
6. 点击"开启事务" → 事务3创建（不提交事务2）
7. 在"数据操作"区域：
   - 事务ID: 3
   - 行ID: 1
   - 点击"读取数据"

结果：事务3看到的是 age=25（事务1的版本），因为事务2还未提交
```

### 示例2：事务回滚

```
1. 开启事务1，插入数据 {"name": "Bob", "age": 30}，提交
2. 开启事务2，更新行1为 {"name": "Bob", "age": 31}（不提交）
3. 点击数据行1，查看版本链（应该有2个版本）
4. 点击事务2的"回滚"按钮
5. 再次查看版本链（应该只有1个版本）
6. 开启事务3，读取行1

结果：事务3看到的是 age=30（回滚后恢复到事务1的版本）
```

### 示例3：复杂的多事务场景

```
1. 事务1：插入 {"name": "Charlie", "age": 40}，提交
2. 事务2：更新为 {"name": "Charlie", "age": 41}，提交
3. 事务3：更新为 {"name": "Charlie", "age": 42}，提交
4. 事务4：更新为 {"name": "Charlie", "age": 43}（不提交）
5. 事务5：读取数据

结果：事务5看到的是 age=42（事务3的版本），看不到事务4的修改
```

---

## 🎯 核心功能说明

### 1. 版本链可视化

**特点**：
- ✅ 最新版本显示在顶部
- ✅ 版本序号越新越大
- ✅ 只在数据变化时刷新
- ✅ 显示完整的 Undo 日志链

**查看方式**：
- 点击"数据行"表格中的任意行
- 右侧面板会显示该行的完整版本链

**版本链信息包括**：
- 版本序号（越新越大）
- 事务ID
- 时间戳
- 数据内容
- Undo Log ID
- DB_ROLL_PTR（指向上一个版本）

### 2. 活跃事务监控

**显示内容**：
- 事务ID和状态
- 隔离级别
- 开始时间
- ReadView 信息（活跃事务列表、范围）
- 操作历史（最近5条，包含具体数据）
- 修改的数据行列表

**操作**：
- 提交事务
- 回滚事务

### 3. 已提交事务历史

**显示内容**：
- 事务ID和状态
- 开始时间和提交时间
- 所有操作的详细信息（包含具体数据）
- 修改的数据行列表

**特点**：
- 显示最近10个已提交事务
- 按提交时间倒序排列

### 4. 数据行表格

**显示内容**：
- DB_ROW_ID（行ID）
- DB_TRX_ID（最后修改的事务ID）
- DB_ROLL_PTR（指向Undo日志的指针）
- 用户数据列
- 状态（正常/已删除）

**交互**：
- 点击任意行查看版本链
- 自动高亮显示

### 5. Undo 日志

**显示内容**：
- Undo Log ID
- 操作类型（INSERT/UPDATE/DELETE）
- 事务ID
- 行ID
- Roll Pointer
- 旧值和新值

**特点**：
- 显示最近20条Undo日志
- 按创建时间倒序排列

### 6. ReadView 信息

**显示内容**：
- 创建者事务ID
- 活跃事务列表（m_ids）
- 最小事务ID
- 最大事务ID
- 创建时间

**用途**：
- 理解事务的可见性范围
- 调试MVCC行为

---

## 🔍 可见性规则说明

### ReadView 的4条规则

```python
# 规则1：自己修改的数据可见
if trx_id == creator_trx_id:
    return True

# 规则2：ReadView创建前已提交的数据可见
if trx_id < min_trx_id:
    return True

# 规则3：ReadView创建后才开始的事务不可见
if trx_id > max_trx_id:
    return False

# 规则4：在范围内但不在活跃列表中的事务可见（已提交）
return trx_id not in m_ids
```

### 实际案例

**场景**：
- 事务1、2已提交
- 事务3、4活跃
- 事务4的ReadView: `m_ids=[3,4]`, `min_trx_id=3`, `max_trx_id=4`

**可见性判断**：
- 事务1（trx_id=1）：`1 < 3` → **可见** ✓
- 事务2（trx_id=2）：`2 < 3` → **可见** ✓
- 事务3（trx_id=3）：`3 in [3,4]` → **不可见** ✗
- 事务4（trx_id=4）：`4 == 4` → **可见**（自己）✓

---

## 🛠️ 故障排查

### 问题1：无法启动服务器

**错误**：`ModuleNotFoundError: No module named 'flask'`

**解决**：
```bash
pip install flask
```

### 问题2：端口被占用

**错误**：`Address already in use`

**解决**：
```bash
# 查找占用端口的进程
lsof -i :5001

# 杀死进程
kill -9 <PID>

# 或者修改 app.py 中的端口号
app.run(host='0.0.0.0', port=5002, debug=True)
```

### 问题3：版本链不刷新

**原因**：版本链只在选中行被修改时才刷新

**解决**：
1. 确保你修改的是当前选中的行
2. 或者重新点击该行来手动刷新

### 问题4：读取不到数据

**可能原因**：
1. 事务未提交，其他事务看不到
2. ReadView 的可见性规则限制

**调试方法**：
1. 查看 ReadView 信息
2. 检查事务的提交状态
3. 查看版本链中的事务ID

---

## 📚 进阶使用

### 隔离级别对比

**READ_COMMITTED**：
- 每次读取都创建新的 ReadView
- 可以读取到其他事务已提交的最新数据

**REPEATABLE_READ**：
- 事务开始时创建 ReadView
- 整个事务期间使用同一个 ReadView
- 保证可重复读

### 分屏对比模式

点击"切换到分屏对比模式"按钮：
- 同时查看两个事务的视角
- 对比不同事务看到的数据版本
- 理解隔离级别的差异

### 系统重置

点击"重置系统"按钮：
- 清空所有事务
- 清空所有数据行
- 清空所有Undo日志
- 重新开始演示

---

## 🎓 学习建议

### 1. 从简单开始

先理解基本的单事务操作：
- 插入数据
- 更新数据
- 删除数据
- 查看版本链

### 2. 理解可见性

创建多个事务，观察：
- 未提交的事务对其他事务不可见
- 已提交的事务对新事务可见
- ReadView 的作用

### 3. 实验回滚

尝试不同的回滚场景：
- INSERT 回滚
- UPDATE 回滚
- DELETE 回滚
- 观察版本链的变化

### 4. 复杂场景

模拟真实的并发场景：
- 多个事务同时修改同一行
- 长事务和短事务的交互
- 不同隔离级别的行为差异

---

## 📝 注意事项

1. **事务ID是自增的**：每次开启事务都会分配新的ID
2. **版本链是累积的**：即使事务提交，版本链也会保留
3. **Undo日志不会自动清理**：在真实的InnoDB中会有purge线程清理
4. **这是教学系统**：简化了很多实现细节，专注于核心概念

---

## 🤝 贡献

如果你发现问题或有改进建议，欢迎：
1. 提交 Issue
2. 创建 Pull Request
3. 分享使用心得

---

## 📖 相关资源

- [MySQL InnoDB 官方文档](https://dev.mysql.com/doc/refman/8.0/en/innodb-storage-engine.html)
- [InnoDB MVCC 原理](https://dev.mysql.com/doc/refman/8.0/en/innodb-multi-versioning.html)
- [事务隔离级别](https://dev.mysql.com/doc/refman/8.0/en/innodb-transaction-isolation-levels.html)

---

## ✨ 更新日志

查看 `IMPROVEMENTS.md` 了解最新的改进和修复。

---

祝你学习愉快！🎉
